name: Multi-Platform Matrix Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build (${{ matrix.variant }})
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        # Simple approach - define 3 explicit variants
        variant: 
          - linux-node18
          - windows-node20  
          - macos-node22
        
        include:
          - variant: linux-node18
            os: ubuntu-latest
            node-version: 18
          - variant: windows-node20
            os: windows-latest
            node-version: 20
          - variant: macos-node22
            os: macos-latest
            node-version: 22
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
    
    - name: matrix-baddcd6
      run: |
        echo "=== Matrix Build Identifier: matrix-baddcd6 ==="
        echo "Building for: ${{ matrix.variant }}"
        echo "OS: ${{ matrix.os }}"
        echo "Node.js: ${{ matrix.node-version }}"
        echo "Run ID: ${{ github.run_id }}"
    
    - name: Create build artifacts
      run: |
        # Create build directory
        mkdir -p dist
        
        # Create main output file
        cat > output.txt << EOF
        Build Output for ${{ matrix.variant }}
        ===============================
        Platform: ${{ matrix.os }}
        Node.js Version: ${{ matrix.node-version }}
        Variant: ${{ matrix.variant }}
        Build Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        GitHub SHA: ${{ github.sha }}
        Workflow: ${{ github.workflow }}
        Run ID: ${{ github.run_id }}
        Run Number: ${{ github.run_number }}
        ===============================
        Build completed successfully!
        EOF
        
        # Create JSON metadata
        cat > build-info.json << EOF
        {
          "build_id": "matrix-baddcd6",
          "platform": "${{ matrix.os }}",
          "node_version": "${{ matrix.node-version }}",
          "variant": "${{ matrix.variant }}",
          "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "commit_hash": "${{ github.sha }}",
          "workflow_run_id": "${{ github.run_id }}"
        }
        EOF
        
        # Create platform-specific simulated binary
        cat > dist/app-${{ matrix.variant }} << EOF
        Simulated Application Binary
        =============================
        Platform: ${{ matrix.os }}
        Node.js: ${{ matrix.node-version }}
        Variant: ${{ matrix.variant }}
        Build Type: Production
        Checksum: $(echo "${{ github.sha }}-${{ matrix.variant }}" | sha256sum | cut -d' ' -f1)
        Size: $(( RANDOM % 1000 + 500 )) KB
        Created: $(date)
        EOF
        
        # Add platform-specific content
        case "${{ matrix.os }}" in
          "ubuntu-latest")
            echo "Platform Features: [linux, systemd, apt]" >> output.txt
            echo "Binary Format: ELF" >> dist/app-${{ matrix.variant }}
            ;;
          "windows-latest")
            echo "Platform Features: [windows, win32, msi]" >> output.txt
            echo "Binary Format: PE" >> dist/app-${{ matrix.variant }}
            ;;
          "macos-latest")
            echo "Platform Features: [macos, darwin, app-bundle]" >> output.txt
            echo "Binary Format: Mach-O" >> dist/app-${{ matrix.variant }}
            ;;
        esac
    
    - name: Validate artifact content
      run: |
        echo "Validating generated artifacts..."
        ls -la
        echo "---"
        ls -la dist/
        
        # Check if files exist and are non-empty
        [ -s output.txt ] || exit 1
        [ -s build-info.json ] || exit 1
        [ -s dist/app-${{ matrix.variant }} ] || exit 1
        
        echo "✅ All artifacts validated successfully!"
        echo "File sizes:"
        wc -l output.txt build-info.json dist/app-${{ matrix.variant }}
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-baddcd6-${{ matrix.variant }}
        path: |
          output.txt
          build-info.json
          dist/app-${{ matrix.variant }}
        retention-days: 7

  validation:
    name: Validate Matrix Build Results
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        pattern: build-baddcd6-*
        merge-multiple: false
    
    - name: Count and validate artifacts
      run: |
        echo "=== Artifact Validation ==="
        echo "Artifact directory structure:"
        find artifacts -type f -name "*.txt" -o -name "*.json" -o -name "app-*" | sort
        
        # Count unique artifact directories with our prefix
        artifact_dirs=$(find artifacts -type d -name "build-baddcd6-*" | wc -l)
        echo "Found $artifact_dirs artifact directories with prefix 'build-baddcd6'"
        
        # Count actual uploaded artifacts in GitHub Actions
        artifact_names=$(ls -d artifacts/build-baddcd6-* 2>/dev/null | wc -l)
        echo "Artifacts found: $artifact_names"
        
        # Validate each artifact directory
        for dir in artifacts/build-baddcd6-*; do
          if [ -d "$dir" ]; then
            echo "Validating $dir..."
            [ -s "$dir/output.txt" ] && [ -s "$dir/build-info.json" ] && [ -s "$dir/dist/app-"* ] && echo "✅ $dir is valid"
          fi
        done
        
        if [ $artifact_names -ge 3 ]; then
          echo "✅ SUCCESS: Found $artifact_names artifacts with prefix 'build-baddcd6'"
          echo "✅ Matrix build validation passed!"
        else
          echo "❌ FAILURE: Expected at least 3 artifacts, found $artifact_names"
          echo "Available artifacts:"
          ls -la artifacts/ || true
          exit 1
        fi
